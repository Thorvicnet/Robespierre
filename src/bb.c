#include "bb.h"

const Bb ROOK_MASKS[64] = {
    0x101010101017e,    0x202020202027c,    0x404040404047a,
    0x8080808080876,    0x1010101010106e,   0x2020202020205e,
    0x4040404040403e,   0x8080808080807e,   0x1010101017e00,
    0x2020202027c00,    0x4040404047a00,    0x8080808087600,
    0x10101010106e00,   0x20202020205e00,   0x40404040403e00,
    0x80808080807e00,   0x10101017e0100,    0x20202027c0200,
    0x40404047a0400,    0x8080808760800,    0x101010106e1000,
    0x202020205e2000,   0x404040403e4000,   0x808080807e8000,
    0x101017e010100,    0x202027c020200,    0x404047a040400,
    0x8080876080800,    0x1010106e101000,   0x2020205e202000,
    0x4040403e404000,   0x8080807e808000,   0x1017e01010100,
    0x2027c02020200,    0x4047a04040400,    0x8087608080800,
    0x10106e10101000,   0x20205e20202000,   0x40403e40404000,
    0x80807e80808000,   0x17e0101010100,    0x27c0202020200,
    0x47a0404040400,    0x8760808080800,    0x106e1010101000,
    0x205e2020202000,   0x403e4040404000,   0x807e8080808000,
    0x7e010101010100,   0x7c020202020200,   0x7a040404040400,
    0x76080808080800,   0x6e101010101000,   0x5e202020202000,
    0x3e404040404000,   0x7e808080808000,   0x7e01010101010100,
    0x7c02020202020200, 0x7a04040404040400, 0x7608080808080800,
    0x6e10101010101000, 0x5e20202020202000, 0x3e40404040404000,
    0x7e80808080808000};

const Bb BISHOP_MASKS[64] = {
    0x40201008040200, 0x402010080400,   0x4020100a00,     0x40221400,
    0x2442800,        0x204085000,      0x20408102000,    0x2040810204000,
    0x20100804020000, 0x40201008040000, 0x4020100a0000,   0x4022140000,
    0x244280000,      0x20408500000,    0x2040810200000,  0x4081020400000,
    0x10080402000200, 0x20100804000400, 0x4020100a000a00, 0x402214001400,
    0x24428002800,    0x2040850005000,  0x4081020002000,  0x8102040004000,
    0x8040200020400,  0x10080400040800, 0x20100a000a1000, 0x40221400142200,
    0x2442800284400,  0x4085000500800,  0x8102000201000,  0x10204000402000,
    0x4020002040800,  0x8040004081000,  0x100a000a102000, 0x22140014224000,
    0x44280028440200, 0x8500050080400,  0x10200020100800, 0x20400040201000,
    0x2000204081000,  0x4000408102000,  0xa000a10204000,  0x14001422400000,
    0x28002844020000, 0x50005008040200, 0x20002010080400, 0x40004020100800,
    0x20408102000,    0x40810204000,    0xa1020400000,    0x142240000000,
    0x284402000000,   0x500804020000,   0x201008040200,   0x402010080400,
    0x2040810204000,  0x4081020400000,  0xa102040000000,  0x14224000000000,
    0x28440200000000, 0x50080402000000, 0x20100804020000, 0x40201008040200};

const Bb KNIGHT_MASKS[64] = {
    0x0000000000020400ULL, 0x0000000000050800ULL, 0x00000000000A1100ULL,
    0x0000000000142200ULL, 0x0000000000284400ULL, 0x0000000000508800ULL,
    0x0000000000A01000ULL, 0x0000000000402000ULL, 0x0000000002040004ULL,
    0x0000000005080008ULL, 0x000000000A110011ULL, 0x0000000014220022ULL,
    0x0000000028440044ULL, 0x0000000050880088ULL, 0x00000000A0100010ULL,
    0x0000000040200020ULL, 0x0000000204000402ULL, 0x0000000508000805ULL,
    0x0000000A1100110AULL, 0x0000001422002214ULL, 0x0000002844004428ULL,
    0x0000005088008850ULL, 0x000000A0100010A0ULL, 0x0000004020002040ULL,
    0x0000020400040200ULL, 0x0000050800080500ULL, 0x00000A1100110A00ULL,
    0x0000142200221400ULL, 0x0000284400442800ULL, 0x0000508800885000ULL,
    0x0000A0100010A000ULL, 0x0000402000204000ULL, 0x0002040004020000ULL,
    0x0005080008050000ULL, 0x000A1100110A0000ULL, 0x0014220022140000ULL,
    0x0028440044280000ULL, 0x0050880088500000ULL, 0x00A0100010A00000ULL,
    0x0040200020400000ULL, 0x0204000402000000ULL, 0x0508000805000000ULL,
    0x0A1100110A000000ULL, 0x1422002214000000ULL, 0x2844004428000000ULL,
    0x5088008850000000ULL, 0xA0100010A0000000ULL, 0x4020002040000000ULL,
    0x0400040200000000ULL, 0x0800080500000000ULL, 0x1100110A00000000ULL,
    0x2200221400000000ULL, 0x4400442800000000ULL, 0x8800885000000000ULL,
    0x100010A000000000ULL, 0x2000204000000000ULL, 0x0004020000000000ULL,
    0x0008050000000000ULL, 0x00110A0000000000ULL, 0x0022140000000000ULL,
    0x0044280000000000ULL, 0x0088500000000000ULL, 0x0010A00000000000ULL,
    0x0020400000000000ULL};

const Bb KING_MASKS[64] = {
    0x0000000000000302ULL, 0x0000000000000705ULL, 0x0000000000000E0AULL,
    0x0000000000001C14ULL, 0x0000000000003828ULL, 0x0000000000007050ULL,
    0x000000000000E0A0ULL, 0x000000000000C040ULL, 0x0000000000030203ULL,
    0x0000000000070507ULL, 0x00000000000E0A0EULL, 0x00000000001C141CULL,
    0x0000000000382838ULL, 0x0000000000705070ULL, 0x0000000000E0A0E0ULL,
    0x0000000000C040C0ULL, 0x0000000003020300ULL, 0x0000000007050700ULL,
    0x000000000E0A0E00ULL, 0x000000001C141C00ULL, 0x0000000038283800ULL,
    0x0000000070507000ULL, 0x00000000E0A0E000ULL, 0x00000000C040C000ULL,
    0x0000000302030000ULL, 0x0000000705070000ULL, 0x0000000E0A0E0000ULL,
    0x0000001C141C0000ULL, 0x0000003828380000ULL, 0x0000007050700000ULL,
    0x000000E0A0E00000ULL, 0x000000C040C00000ULL, 0x0000030203000000ULL,
    0x0000070507000000ULL, 0x00000E0A0E000000ULL, 0x00001C141C000000ULL,
    0x0000382838000000ULL, 0x0000705070000000ULL, 0x0000E0A0E0000000ULL,
    0x0000C040C0000000ULL, 0x0003020300000000ULL, 0x0007050700000000ULL,
    0x000E0A0E00000000ULL, 0x001C141C00000000ULL, 0x0038283800000000ULL,
    0x0070507000000000ULL, 0x00E0A0E000000000ULL, 0x00C040C000000000ULL,
    0x0302030000000000ULL, 0x0705070000000000ULL, 0x0E0A0E0000000000ULL,
    0x1C141C0000000000ULL, 0x3828380000000000ULL, 0x7050700000000000ULL,
    0xE0A0E00000000000ULL, 0xC040C00000000000ULL, 0x0203000000000000ULL,
    0x0507000000000000ULL, 0x0A0E000000000000ULL, 0x141C000000000000ULL,
    0x2838000000000000ULL, 0x5070000000000000ULL, 0xA0E0000000000000ULL,
    0x40C0000000000000ULL};

const Bb PAWN_ATTACK_MASKS_WHITE[64] = {
    0x0000000000000200ULL, 0x0000000000000500ULL, 0x0000000000000A00ULL,
    0x0000000000001400ULL, 0x0000000000002800ULL, 0x0000000000005000ULL,
    0x000000000000A000ULL, 0x0000000000004000ULL, 0x0000000000020000ULL,
    0x0000000000050000ULL, 0x00000000000A0000ULL, 0x0000000000140000ULL,
    0x0000000000280000ULL, 0x0000000000500000ULL, 0x0000000000A00000ULL,
    0x0000000000400000ULL, 0x0000000002000000ULL, 0x0000000005000000ULL,
    0x000000000A000000ULL, 0x0000000014000000ULL, 0x0000000028000000ULL,
    0x0000000050000000ULL, 0x00000000A0000000ULL, 0x0000000040000000ULL,
    0x0000000200000000ULL, 0x0000000500000000ULL, 0x0000000A00000000ULL,
    0x0000001400000000ULL, 0x0000002800000000ULL, 0x0000005000000000ULL,
    0x000000A000000000ULL, 0x0000004000000000ULL, 0x0000020000000000ULL,
    0x0000050000000000ULL, 0x00000A0000000000ULL, 0x0000140000000000ULL,
    0x0000280000000000ULL, 0x0000500000000000ULL, 0x0000A00000000000ULL,
    0x0000400000000000ULL, 0x0002000000000000ULL, 0x0005000000000000ULL,
    0x000A000000000000ULL, 0x0014000000000000ULL, 0x0028000000000000ULL,
    0x0050000000000000ULL, 0x00A0000000000000ULL, 0x0040000000000000ULL,
    0x0200000000000000ULL, 0x0500000000000000ULL, 0x0A00000000000000ULL,
    0x1400000000000000ULL, 0x2800000000000000ULL, 0x5000000000000000ULL,
    0xA000000000000000ULL, 0x4000000000000000ULL, 0x0000000000000000ULL,
    0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
    0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
    0x0000000000000000ULL};

const Bb PAWN_ATTACK_MASKS_BLACK[64] = {
    0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
    0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
    0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000002ULL,
    0x0000000000000005ULL, 0x000000000000000AULL, 0x0000000000000014ULL,
    0x0000000000000028ULL, 0x0000000000000050ULL, 0x00000000000000A0ULL,
    0x0000000000000040ULL, 0x0000000000000200ULL, 0x0000000000000500ULL,
    0x0000000000000A00ULL, 0x0000000000001400ULL, 0x0000000000002800ULL,
    0x0000000000005000ULL, 0x000000000000A000ULL, 0x0000000000004000ULL,
    0x0000000000020000ULL, 0x0000000000050000ULL, 0x00000000000A0000ULL,
    0x0000000000140000ULL, 0x0000000000280000ULL, 0x0000000000500000ULL,
    0x0000000000A00000ULL, 0x0000000000400000ULL, 0x0000000002000000ULL,
    0x0000000005000000ULL, 0x000000000A000000ULL, 0x0000000014000000ULL,
    0x0000000028000000ULL, 0x0000000050000000ULL, 0x00000000A0000000ULL,
    0x0000000040000000ULL, 0x0000000200000000ULL, 0x0000000500000000ULL,
    0x0000000A00000000ULL, 0x0000001400000000ULL, 0x0000002800000000ULL,
    0x0000005000000000ULL, 0x000000A000000000ULL, 0x0000004000000000ULL,
    0x0000020000000000ULL, 0x0000050000000000ULL, 0x00000A0000000000ULL,
    0x0000140000000000ULL, 0x0000280000000000ULL, 0x0000500000000000ULL,
    0x0000A00000000000ULL, 0x0000400000000000ULL, 0x0002000000000000ULL,
    0x0005000000000000ULL, 0x000A000000000000ULL, 0x0014000000000000ULL,
    0x0028000000000000ULL, 0x0050000000000000ULL, 0x00A0000000000000ULL,
    0x0040000000000000ULL};

// MAGIC BITBOARDS computed from magic.c script:
const Bb ROOK_MAGIC[64] = {
    0xa8002c000108020ULL,  0x6c00049b0002001ULL,  0x100200010090040ULL,
    0x2480041000800801ULL, 0x280028004000800ULL,  0x900410008040022ULL,
    0x280020001001080ULL,  0x2880002041000080ULL, 0xa000800080400034ULL,
    0x4808020004000ULL,    0x2290802004801000ULL, 0x411000d00100020ULL,
    0x402800800040080ULL,  0xb000401004208ULL,    0x2409000100040200ULL,
    0x1002100004082ULL,    0x22878001e24000ULL,   0x1090810021004010ULL,
    0x801030040200012ULL,  0x500808008001000ULL,  0xa08018014000880ULL,
    0x8000808004000200ULL, 0x201008080010200ULL,  0x801020000441091ULL,
    0x800080204005ULL,     0x1040200040100048ULL, 0x120200402082ULL,
    0xd14880480100080ULL,  0x12040280080080ULL,   0x100040080020080ULL,
    0x9020010080800200ULL, 0x813241200148449ULL,  0x491604001800080ULL,
    0x100401000402001ULL,  0x4820010021001040ULL, 0x400402202000812ULL,
    0x209009005000802ULL,  0x810800601800400ULL,  0x4301083214000150ULL,
    0x204026458e001401ULL, 0x40204000808000ULL,   0x8001008040010020ULL,
    0x8410820820420010ULL, 0x1003001000090020ULL, 0x804040008008080ULL,
    0x12000810020004ULL,   0x1000100200040208ULL, 0x430000a044020001ULL,
    0x280009023410300ULL,  0xe0100040002240ULL,   0x200100401700ULL,
    0x2244100408008080ULL, 0x8000400801980ULL,    0x2000810040200ULL,
    0x8010100228810400ULL, 0x2000009044210200ULL, 0x4080008040102101ULL,
    0x40002080411d01ULL,   0x2005524060000901ULL, 0x502001008400422ULL,
    0x489a000810200402ULL, 0x1004400080a13ULL,    0x4000011008020084ULL,
    0x26002114058042ULL,
};

const Bb BISHOP_MAGIC[64] = {
    0x89a1121896040240ULL, 0x2004844802002010ULL, 0x2068080051921000ULL,
    0x62880a0220200808ULL, 0x4042004000000ULL,    0x100822020200011ULL,
    0xc00444222012000aULL, 0x28808801216001ULL,   0x400492088408100ULL,
    0x201c401040c0084ULL,  0x840800910a0010ULL,   0x82080240060ULL,
    0x2000840504006000ULL, 0x30010c4108405004ULL, 0x1008005410080802ULL,
    0x8144042209100900ULL, 0x208081020014400ULL,  0x4800201208ca00ULL,
    0xf18140408012008ULL,  0x1004002802102001ULL, 0x841000820080811ULL,
    0x40200200a42008ULL,   0x800054042000ULL,     0x88010400410c9000ULL,
    0x520040470104290ULL,  0x1004040051500081ULL, 0x2002081833080021ULL,
    0x400c00c010142ULL,    0x941408200c002000ULL, 0x658810000806011ULL,
    0x188071040440a00ULL,  0x4800404002011c00ULL, 0x104442040404200ULL,
    0x511080202091021ULL,  0x4022401120400ULL,    0x80c0040400080120ULL,
    0x8040010040820802ULL, 0x480810700020090ULL,  0x102008e00040242ULL,
    0x809005202050100ULL,  0x8002024220104080ULL, 0x431008804142000ULL,
    0x19001802081400ULL,   0x200014208040080ULL,  0x3308082008200100ULL,
    0x41010500040c020ULL,  0x4012020c04210308ULL, 0x208220a202004080ULL,
    0x111040120082000ULL,  0x6803040141280a00ULL, 0x2101004202410000ULL,
    0x8200000041108022ULL, 0x21082088000ULL,      0x2410204010040ULL,
    0x40100400809000ULL,   0x822088220820214ULL,  0x40808090012004ULL,
    0x910224040218c9ULL,   0x402814422015008ULL,  0x90014004842410ULL,
    0x1000042304105ULL,    0x10008830412a00ULL,   0x2520081090008908ULL,
    0x40102000a0a60140ULL,
};

int RBits[64] = {12, 11, 11, 11, 11, 11, 11, 12, 11, 10, 10, 10, 10,
                 10, 10, 11, 11, 10, 10, 10, 10, 10, 10, 11, 11, 10,
                 10, 10, 10, 10, 10, 11, 11, 10, 10, 10, 10, 10, 10,
                 11, 11, 10, 10, 10, 10, 10, 10, 11, 11, 10, 10, 10,
                 10, 10, 10, 11, 12, 11, 11, 11, 11, 11, 11, 12};

int BBits[64] = {6, 5, 5, 5, 5, 5, 5, 6, 5, 5, 5, 5, 5, 5, 5, 5,
                 5, 5, 7, 7, 7, 7, 5, 5, 5, 5, 7, 9, 9, 7, 5, 5,
                 5, 5, 7, 9, 9, 7, 5, 5, 5, 5, 7, 7, 7, 7, 5, 5,
                 5, 5, 5, 5, 5, 5, 5, 5, 6, 5, 5, 5, 5, 5, 5, 6};

void bb_board_init(Board *board) {
  // Initiate the bitboards inside the board
  board->white_pawns = 0x000000000000FF00ULL;
  board->white_rooks = 0x0000000000000081ULL;
  board->white_knights = 0x0000000000000042ULL;
  board->white_bishops = 0x0000000000000024ULL;
  board->white_queens = 0x0000000000000008ULL;
  board->white_kings = 0x0000000000000010ULL;

  board->black_pawns = 0x00FF000000000000ULL;
  board->black_rooks = 0x8100000000000000ULL;
  board->black_knights = 0x4200000000000000ULL;
  board->black_bishops = 0x2400000000000000ULL;
  board->black_queens = 0x0800000000000000ULL;
  board->black_kings = 0x1000000000000000ULL;

  board->white = board->white_pawns | board->white_rooks |
                 board->white_knights | board->white_knights |
                 board->white_bishops | board->white_queens |
                 board->white_kings;
  board->black = board->black_pawns | board->black_rooks |
                 board->black_knights | board->black_knights |
                 board->black_bishops | board->black_queens |
                 board->black_kings;

  board->all = board->white | board->black;
}

void bb_board_empty(Board *board) {
  // Empties the bitboards inside the board (for testing purposes)
  board->white_pawns = 0ULL;
  board->white_rooks = 0ULL;
  board->white_knights = 0ULL;
  board->white_bishops = 0ULL;
  board->white_queens = 0ULL;
  board->white_kings = 0ULL;

  board->black_pawns = 0ULL;
  board->black_rooks = 0ULL;
  board->black_knights = 0ULL;
  board->black_bishops = 0ULL;
  board->black_queens = 0ULL;
  board->black_kings = 0ULL;

  board->white = 0ULL;
  board->black = 0ULL;
  board->all = 0ULL;
}

Bb ROOK_ATTACKS[64][4096];
Bb BISHOP_ATTACKS[64][4096];

const int BitTable[64] = {63, 30, 3,  32, 25, 41, 22, 33, 15, 50, 42, 13, 11,
                          53, 19, 34, 61, 29, 2,  51, 21, 43, 45, 10, 18, 47,
                          1,  54, 9,  57, 0,  35, 62, 31, 40, 4,  49, 5,  52,
                          26, 60, 6,  23, 44, 46, 27, 56, 16, 7,  39, 48, 24,
                          59, 14, 12, 55, 38, 28, 58, 20, 37, 17, 36, 8};

int pop_1st_bit(Bb *bb) {
  Bb b = *bb ^ (*bb - 1);
  unsigned int fold = (unsigned)((b & 0xffffffff) ^ (b >> 32));
  *bb &= (*bb - 1);
  return BitTable[(fold * 0x783a9b23) >> 26];
}

Bb index_to_Bb(int index, int bits, Bb m) {
  int i, j;
  Bb result = 0ULL;
  for (i = 0; i < bits; i++) {
    j = pop_1st_bit(&m);
    if (index & (1 << i))
      result |= (1ULL << j);
  }
  return result;
}

Bb ratt(int sq, Bb block) { // rook attacks
  Bb result = 0ULL;
  int rk = sq / 8, fl = sq % 8, r, f;
  for (r = rk + 1; r <= 7; r++) {
    result |= (1ULL << (fl + r * 8));
    if (block & (1ULL << (fl + r * 8)))
      break;
  }
  for (r = rk - 1; r >= 0; r--) {
    result |= (1ULL << (fl + r * 8));
    if (block & (1ULL << (fl + r * 8)))
      break;
  }
  for (f = fl + 1; f <= 7; f++) {
    result |= (1ULL << (f + rk * 8));
    if (block & (1ULL << (f + rk * 8)))
      break;
  }
  for (f = fl - 1; f >= 0; f--) {
    result |= (1ULL << (f + rk * 8));
    if (block & (1ULL << (f + rk * 8)))
      break;
  }
  return result;
}

Bb batt(int sq, Bb block) { // bishop attacks
  Bb result = 0ULL;
  int rk = sq / 8, fl = sq % 8, r, f;
  for (r = rk + 1, f = fl + 1; r <= 7 && f <= 7; r++, f++) {
    result |= (1ULL << (f + r * 8));
    if (block & (1ULL << (f + r * 8)))
      break;
  }
  for (r = rk + 1, f = fl - 1; r <= 7 && f >= 0; r++, f--) {
    result |= (1ULL << (f + r * 8));
    if (block & (1ULL << (f + r * 8)))
      break;
  }
  for (r = rk - 1, f = fl + 1; r >= 0 && f <= 7; r--, f++) {
    result |= (1ULL << (f + r * 8));
    if (block & (1ULL << (f + r * 8)))
      break;
  }
  for (r = rk - 1, f = fl - 1; r >= 0 && f >= 0; r--, f--) {
    result |= (1ULL << (f + r * 8));
    if (block & (1ULL << (f + r * 8)))
      break;
  }
  return result;
}

void bb_magic_init(void) {
  for (int sq = 0; sq < 64; sq++) {
    Bb rmask_sq = ROOK_MASKS[sq];
    int rbits = RBits[sq];
    int rook_subsets = (1 << rbits);

    for (int idx = 0; idx < rook_subsets; idx++) {
      Bb occupancy = index_to_Bb(idx, rbits, rmask_sq);
      int tableIndex = (int)(((occupancy * ROOK_MAGIC[sq]) >> (64 - rbits)));
      ROOK_ATTACKS[sq][tableIndex] = ratt(sq, occupancy);
    }

    Bb bmask_sq = BISHOP_MASKS[sq];
    int bbits = BBits[sq];
    int bishop_subsets = (1 << bbits);

    for (int idx = 0; idx < bishop_subsets; idx++) {
      Bb occupancy = index_to_Bb(idx, bbits, bmask_sq);
      int tableIndex = (int)(((occupancy * BISHOP_MAGIC[sq]) >> (64 - bbits)));
      BISHOP_ATTACKS[sq][tableIndex] = batt(sq, occupancy);
    }
  }
}

Bb bb_rook_attacks(Bb occ, int sq) {
  Bb mask = ROOK_MASKS[sq];
  int bits = RBits[sq];
  int index = ((occ & mask) * ROOK_MAGIC[sq]) >> (64 - bits);
  return ROOK_ATTACKS[sq][index];
}

Bb bb_bishop_attacks(Bb occ, int sq) {
  Bb mask = BISHOP_MASKS[sq];
  int bits = BBits[sq];
  int index = ((occ & mask) * BISHOP_MAGIC[sq]) >> (64 - bits);
  return BISHOP_ATTACKS[sq][index];
}

void bb_print(Bb bb) {
  for (int rank = 0; rank < 8; rank++) {
    for (int file = 0; file < 8; file++) {
      int square = rank * 8 + file; // Map rank/file to square index
      wprintf(L"%c ", (bb & (1ULL << square)) ? '1' : '.');
    }
    wprintf(L"\n");
  }
  wprintf(L"\n");
}
